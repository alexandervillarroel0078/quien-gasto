<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin Productos</title>

<style>
body{font-family:Arial;background:#f5f6fa;padding:20px}
table{width:100%;background:#fff;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#222;color:#fff}
input,select,button{padding:6px;margin:3px}
#formProducto,#panelProductos{display:none;background:#fff;padding:10px;border:1px solid #ddd;margin-top:10px}
.error{color:red;margin-top:5px}
</style>
</head>
<body>

<h2>Panel ADMIN - Productos</h2>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
  <input id="correo" placeholder="Correo">
  <input id="password" type="password" placeholder="Contrase√±a">
  <button onclick="login()">Entrar</button>
  <div class="error" id="loginMsg"></div>
</div>

<!-- ================= PRODUCTOS ================= -->
<div id="panelProductos">

<button onclick="nuevo()">‚ûï Nuevo producto</button>

<div id="formProducto">
  <input id="codigo" placeholder="C√≥digo">
  <input id="nombre" placeholder="Nombre del producto">
  <input id="base" type="number" placeholder="Precio base">
  <input id="min" type="number" placeholder="Precio m√≠nimo">
  <input id="max" type="number" placeholder="Precio m√°ximo">

  <!-- SELECTS -->
  <select id="unidad"></select>
  <select id="marca"></select>

  <br>
  <button onclick="guardar()">üíæ Guardar</button>
  <button onclick="cancelar()">‚ùå Cancelar</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>C√≥digo</th>
<th>Nombre</th>
<th>Base</th>
<th>Min</th>
<th>Max</th>
<th>Stock</th>
<th>Costo Promedio</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

</div>

<script>
const API="http://localhost:8000"
const v=id=>document.getElementById(id).value
let token=null
let editId=null

// ================= LOGIN =================
async function login(){
  const res = await fetch(`${API}/auth/login`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      correo:v("correo"),
      password:v("password")
    })
  })

  const data = await res.json()

  if(!res.ok){
    loginMsg.textContent = data.detail || "Error"
    return
  }

  if(data.rol !== "ADMIN"){
    loginMsg.textContent = "Solo ADMIN puede ingresar"
    return
  }

  token = data.access_token
  loginBox.style.display="none"
  panelProductos.style.display="block"

  cargarUnidades()
  cargarMarcas()
  cargarProductos()
}

// ================= FORM =================
function nuevo(){
  editId=null
  document.querySelectorAll("#formProducto input").forEach(i=>i.value="")
  formProducto.style.display="block"
}

function editar(p){
  editId=p.id
  codigo.value=p.codigo
  nombre.value=p.nombre
  base.value=p.precio_base
  min.value=p.precio_min
  max.value=p.precio_max
  unidad.value=p.unidad_id
  marca.value=p.marca_id || ""
  formProducto.style.display="block"
}

function cancelar(){
  editId=null
  formProducto.style.display="none"
}

// ================= UNIDADES =================
async function cargarUnidades(){
  const r=await fetch(`${API}/unidades/`,{
    headers:{Authorization:`Bearer ${token}`}
  })
  const d=await r.json()
  unidad.innerHTML=d.map(u=>`<option value="${u.id}">${u.codigo}</option>`).join("")
}

// ================= MARCAS =================
async function cargarMarcas(){
  const r=await fetch(`${API}/marcas/`,{
    headers:{Authorization:`Bearer ${token}`}
  })
  const d=await r.json()
  marca.innerHTML=`<option value="">Sin marca</option>`+
    d.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join("")
}

// ================= PRODUCTOS =================
async function cargarProductos(){
  const r=await fetch(`${API}/productos/`,{
    headers:{Authorization:`Bearer ${token}`}
  })
  const d=await r.json()
  tabla.innerHTML=d.map(p=>`
    <tr>
      <td>${p.id}</td>
      <td>${p.codigo}</td>
      <td>${p.nombre}</td>
      <td>${p.precio_base}</td>
      <td>${p.precio_min}</td>
      <td>${p.precio_max}</td>
      <td>${p.stock}</td>
      <td>${p.costo_promedio}</td>
      <td>
        <button onclick='editar(${JSON.stringify(p)})'>‚úèÔ∏è</button>
        <button onclick="eliminar(${p.id})">üóë</button>
      </td>
    </tr>`).join("")
}

// ================= GUARDAR =================
async function guardar(){
  const payload={
    codigo:v("codigo"),
    nombre:v("nombre"),
    precio_base:+v("base"),
    precio_min:+v("min"),
    precio_max:+v("max"),
    unidad_id:+v("unidad"),
    marca_id:v("marca")||null
  }

  const url=editId?`${API}/productos/${editId}`:`${API}/productos/`
  const method=editId?"PUT":"POST"

  await fetch(url,{
    method,
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify(payload)
  })

  cancelar()
  cargarProductos()
}

// ================= ELIMINAR =================
async function eliminar(id){
  await fetch(`${API}/productos/${id}`,{
    method:"DELETE",
    headers:{Authorization:`Bearer ${token}`}
  })
  cargarProductos()
}
</script>

</body>
</html>
